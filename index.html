<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Layanan Bimbingan Konseling - Pondok Pesantren Al-Umm</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(5deg); }
            66% { transform: translate(-20px, 20px) rotate(-5deg); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .service-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .service-card:hover::before {
            opacity: 1;
        }
        
        .service-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.3);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-width: 900px;
            width: 100%;
            max-height: 90%;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            min-width: 300px;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #10b981 0%, #8b5cf6 50%, #a855f7 100%);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white !important;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full overflow-auto" style="background: linear-gradient(135deg, #f5f3ff 0%, #f0fdf4 100%); margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
  <div class="h-full w-full"><!-- Login Screen -->
   <div id="loginScreen" class="w-full" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative; overflow: hidden;"><!-- Animated Background -->
    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0;">
     <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 50%); animation: float 15s ease-in-out infinite;"></div>
     <div style="position: absolute; top: -30%; right: -30%; width: 150%; height: 150%; background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 50%); animation: float 20s ease-in-out infinite reverse;"></div>
    </div>
    <div class="fade-in" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 20px 60px rgba(139, 92, 246, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.5) inset; padding: 35px 40px; max-width: 420px; width: 100%; position: relative; z-index: 1;">
     <div style="text-align: center; margin-bottom: 30px;">
      <div style="width: 90px; height: 90px; margin: 0 auto 15px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3); position: relative;">
       <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); opacity: 0.1; animation: rotate 10s linear infinite;"></div><img src="https://iili.io/fENwpbp.md.png" alt="Logo Pondok Pesantren" style="width: 100%; height: 100%; object-fit: cover; position: relative; z-index: 1;">
      </div>
      <h1 id="siteTitle" class="gradient-text" style="font-size: 24px; font-weight: 800; margin-bottom: 6px; letter-spacing: -0.3px; line-height: 1.2;">Layanan Bimbingan Konseling</h1>
      <p id="institutionName" style="font-size: 14px; color: #6b7280; font-weight: 500; margin: 0;">Pondok Pesantren Al-Umm</p>
     </div>
     <form id="loginForm" style="display: flex; flex-direction: column; gap: 18px;">
      <div><label for="username" style="display: block; font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 8px; letter-spacing: 0.2px;">üë§ USERNAME</label>
       <div style="position: relative;"><input type="text" id="username" name="username" required placeholder="Masukkan username" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; transition: all 0.3s; box-sizing: border-box; background: white;" onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
       </div>
      </div>
      <div><label for="password" style="display: block; font-size: 13px; font-weight: 700; color: #374151; margin-bottom: 8px; letter-spacing: 0.2px;">üîí PASSWORD</label>
       <div style="position: relative;"><input type="password" id="password" name="password" required autocomplete="current-password" placeholder="Masukkan password" style="width: 100%; padding: 12px 45px 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; transition: all 0.3s; box-sizing: border-box; background: white;" onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"> <button type="button" id="togglePassword" onclick="togglePasswordVisibility()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 6px; border-radius: 6px; transition: all 0.3s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
         <svg id="eyeIcon" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path> <circle cx="12" cy="12" r="3"></circle>
         </svg>
         <svg id="eyeOffIcon" style="display: none;" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path> <line x1="1" y1="1" x2="23" y2="23"></line>
         </svg></button>
       </div>
      </div><button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 8px; box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3); letter-spacing: 0.3px; display: flex; align-items: center; justify-content: center; gap: 10px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(139, 92, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(139, 92, 246, 0.3)'">
       <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"></path> <path d="M10 14L21 3"></path> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
       </svg><span>MASUK SEKARANG</span> </button>
     </form>
    </div>
   </div><!-- Main Application -->
   <div id="mainApp" style="display: none;" class="w-full h-full"><!-- Header -->
    <header class="no-print" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px 40px;">
     <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
      <div style="display: flex; align-items: center; gap: 20px;">
       <div style="width: 60px; height: 60px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);"><img src="https://iili.io/fENwpbp.md.png" alt="Logo" style="width: 100%; height: 100%; object-fit: cover;">
       </div>
       <div>
        <h1 style="font-size: 20px; font-weight: 700; color: #1f2937; margin: 0;">Pondok Pesantren Al-Umm</h1>
        <p id="guruName" style="font-size: 14px; color: #6b7280; margin: 4px 0 0 0;">Guru BK</p>
       </div>
      </div>
      <nav style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;"><button onclick="showPage('layanan')" class="nav-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"> Layanan BK </button> <button onclick="showPage('dataSiswa')" class="nav-btn" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"> Data Siswa </button> <button onclick="showPage('laporan')" class="nav-btn" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"> Laporan </button> <button onclick="logout()" style="padding: 10px 20px; background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"> Logout </button>
      </nav>
     </div>
    </header><!-- Layanan BK Page -->
    <div id="layananPage" style="padding: 40px; max-width: 1400px; margin: 0 auto;">
     <div class="fade-in">
      <h2 class="gradient-text" style="font-size: 32px; font-weight: 700; margin-bottom: 10px; text-align: center;">Pilih Jenis Layanan</h2>
      <p style="text-align: center; color: #6b7280; margin-bottom: 40px;">Klik salah satu layanan untuk mengisi form</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 50px; max-width: 1000px; margin-left: auto; margin-right: auto;">
       <div class="service-card" onclick="openServiceModal('Konseling Individu')" style="background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); padding: 30px 20px; border-radius: 16px; cursor: pointer; text-align: center; color: white;">
        <div style="font-size: 40px; margin-bottom: 12px;">
         üë§
        </div>
        <h3 style="font-size: 16px; font-weight: 700; margin: 0;">Konseling Individu</h3>
       </div>
       <div class="service-card" onclick="openServiceModal('Konseling Kelompok')" style="background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); padding: 30px 20px; border-radius: 16px; cursor: pointer; text-align: center; color: white;">
        <div style="font-size: 40px; margin-bottom: 12px;">
         üë•
        </div>
        <h3 style="font-size: 16px; font-weight: 700; margin: 0;">Konseling Kelompok</h3>
       </div>
       <div class="service-card" onclick="openServiceModal('Bimbingan Kelompok')" style="background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); padding: 30px 20px; border-radius: 16px; cursor: pointer; text-align: center; color: white;">
        <div style="font-size: 40px; margin-bottom: 12px;">
         ü§ù
        </div>
        <h3 style="font-size: 16px; font-weight: 700; margin: 0;">Bimbingan Kelompok</h3>
       </div>
       <div class="service-card" onclick="openServiceModal('Bimbingan Kelas')" style="background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); padding: 30px 20px; border-radius: 16px; cursor: pointer; text-align: center; color: white;">
        <div style="font-size: 40px; margin-bottom: 12px;">
         üè´
        </div>
        <h3 style="font-size: 16px; font-weight: 700; margin: 0;">Bimbingan Kelas</h3>
       </div>
      </div><!-- Riwayat Layanan Hari Ini -->
      <div style="background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(139, 92, 246, 0.1); padding: 35px; margin-top: 40px;">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <h3 class="gradient-text" style="font-size: 24px; font-weight: 700; margin: 0;">Riwayat Layanan Hari Ini</h3><button onclick="refreshRiwayatData()" style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);"> üîÑ Refresh Data </button>
       </div><!-- Filter Riwayat -->
       <div style="background: linear-gradient(135deg, #f0fdf4 0%, #f5f3ff 100%); border-radius: 16px; padding: 25px; margin-bottom: 30px;">
        <h4 style="font-size: 16px; font-weight: 700; color: #374151; margin-bottom: 20px;">Filter Pencarian</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
         <div><label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">Kelas</label> <select id="riwayatKelas" onchange="updateRiwayatSiswa()" style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;"> <option value="">Semua Kelas</option> </select>
         </div>
         <div><label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">Nama Siswa</label> <select id="riwayatNamaSiswa" style="width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;"> <option value="">Semua Siswa</option> </select>
         </div>
        </div>
        <div style="display: flex; gap: 10px;"><button onclick="applyRiwayatFilter()" style="padding: 10px 24px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> Terapkan Filter </button> <button onclick="resetRiwayatFilter()" style="padding: 10px 24px; background: #f3f4f6; color: #374151; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> Reset </button>
        </div>
       </div><!-- Kartu Riwayat -->
       <div id="loadingRiwayat" style="text-align: center; padding: 40px; color: #6b7280;">
        Memuat riwayat layanan...
       </div>
       <div id="riwayatContainer" style="display: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;"></div>
      </div>
     </div>
    </div><!-- Data Siswa Page -->
    <div id="dataSiswaPage" style="display: none; padding: 40px; max-width: 1400px; margin: 0 auto;">
     <div class="fade-in">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
       <h2 style="font-size: 32px; font-weight: 700; color: #1f2937; margin: 0;">Data Siswa</h2><button onclick="refreshSiswaData()" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> üîÑ Refresh Data </button>
      </div>
      <div id="loadingSiswa" style="text-align: center; padding: 40px; color: #6b7280;">
       Memuat data siswa...
      </div>
      <div id="siswaContainer" style="display: none;"></div>
     </div>
    </div><!-- Laporan Page -->
    <div id="laporanPage" style="display: none; padding: 40px; max-width: 1600px; margin: 0 auto;">
     <div class="fade-in">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
       <h2 style="font-size: 32px; font-weight: 700; color: #1f2937; margin: 0;">Laporan Layanan BK</h2><button onclick="refreshLaporanData()" class="no-print" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> üîÑ Refresh Data </button>
      </div><!-- Diagram Lingkaran Per Kelas -->
      <div style="background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); padding: 30px; margin-bottom: 30px;">
       <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 30px; text-align: center;">Diagram Layanan Per Kelas</h3>
       <div id="diagramContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px;"></div>
      </div><!-- Filter -->
      <div class="no-print" style="background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); padding: 30px; margin-bottom: 30px;">
       <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 20px;">Filter Pencarian</h3>
       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Dari Tanggal</label> <input type="date" id="filterTanggalMulai" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
        </div>
        <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Sampai Tanggal</label> <input type="date" id="filterTanggalSelesai" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
        </div>
        <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Kelas</label> <select id="filterKelas" onchange="updateFilterSiswa()" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;"> <option value="">Semua Kelas</option> </select>
        </div>
        <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Nama Siswa</label> <select id="filterNamaSiswa" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;"> <option value="">Semua Siswa</option> </select>
        </div>
        <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Kepala Sekolah/Madrasah</label> <select id="prinicipalSelect" style="width: 100%; padding: 12px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> <option value="">Pilih Kepala Sekolah/Madrasah</option> <option value="Heri Bagus Ardiansyah, M.Pd.">Heri Bagus Ardiansyah, M.Pd. (Kepala Sekolah)</option> <option value="Abd. Wahid, S.Pd., M.Si.">Abd. Wahid, S.Pd., M.Si. (Kepala Madrasah)</option> </select>
        </div>
       </div>
       <div style="display: flex; gap: 10px; flex-wrap: wrap;"><button onclick="applyFilter()" style="margin-top: 20px; padding: 12px 30px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> Terapkan Filter </button> <button onclick="resetFilter()" style="margin-top: 20px; padding: 12px 30px; background: #f3f4f6; color: #374151; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> Reset </button> <button onclick="printLaporan()" style="margin-top: 20px; padding: 12px 30px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);"> üñ®Ô∏è Cetak Laporan </button>
       </div>
      </div><!-- Results Table -->
      <div style="background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); padding: 30px; overflow-x: auto;">
       <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 20px;">Hasil Pencarian</h3>
       <div id="loadingLaporan" style="text-align: center; padding: 40px; color: #6b7280;">
        Memuat data laporan...
       </div>
       <table id="tableLaporan" style="width: 100%; display: none; border-collapse: collapse;">
        <thead>
         <tr style="background: linear-gradient(135deg, #f0fdf4 0%, #f5f3ff 100%); border-bottom: 2px solid #e5e7eb;">
          <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Tanggal</th>
          <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Jenis Layanan</th>
          <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Bidang Layanan</th>
          <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Kelas</th>
          <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Nama Siswa</th>
          <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Uraian Kegiatan</th>
          <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Hasil &amp; Tindak Lanjut</th>
         </tr>
        </thead>
        <tbody id="laporanTableBody"></tbody>
       </table>
      </div>
     </div>
    </div>
   </div><!-- Modal Riwayat Siswa -->
   <div id="modalRiwayatSiswa" class="modal-overlay" style="display: none;">
    <div class="modal-content">
     <div style="padding: 40px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
       <div>
        <h3 id="modalRiwayatTitle" class="gradient-text" style="font-size: 24px; font-weight: 700; margin: 0 0 5px 0;"></h3>
        <p id="modalRiwayatSubtitle" style="font-size: 14px; color: #6b7280; margin: 0;"></p>
       </div><button onclick="closeRiwayatModal()" style="background: none; border: none; font-size: 28px; color: #6b7280; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.3s;"> √ó </button>
      </div>
      <div id="modalRiwayatContent" style="max-height: 500px; overflow-y: auto;"><!-- Riwayat akan diisi di sini -->
      </div>
     </div>
    </div>
   </div><!-- Modal Form -->
   <div id="modalForm" class="modal-overlay" style="display: none;">
    <div class="modal-content">
     <div style="padding: 40px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
       <h3 id="modalTitle" class="gradient-text" style="font-size: 24px; font-weight: 700; margin: 0;"></h3><button onclick="closeModal()" style="background: none; border: none; font-size: 28px; color: #6b7280; cursor: pointer; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.3s;"> √ó </button>
      </div>
      <form id="serviceForm" style="display: flex; flex-direction: column; gap: 25px;" onkeydown="if(event.key === 'Enter') { event.preventDefault(); }">
       <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Tanggal Layanan</label> <input type="date" id="tanggalLayanan" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
        </div>
        <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Jenis Layanan</label> <input type="text" id="jenisLayanan" readonly style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; background: #f9fafb;">
        </div>
       </div>
       <div><label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">Bidang Layanan (Boleh pilih lebih dari satu)</label>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;"><label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s;"> <input type="checkbox" name="bidangLayanan" value="Pribadi" style="width: 18px; height: 18px; cursor: pointer;"> <span style="font-size: 14px; color: #374151;">Pribadi</span> </label> <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s;"> <input type="checkbox" name="bidangLayanan" value="Sosial" style="width: 18px; height: 18px; cursor: pointer;"> <span style="font-size: 14px; color: #374151;">Sosial</span> </label> <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s;"> <input type="checkbox" name="bidangLayanan" value="Belajar" style="width: 18px; height: 18px; cursor: pointer;"> <span style="font-size: 14px; color: #374151;">Belajar</span> </label> <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.3s;"> <input type="checkbox" name="bidangLayanan" value="Karir" style="width: 18px; height: 18px; cursor: pointer;"> <span style="font-size: 14px; color: #374151;">Karir</span> </label>
        </div>
       </div><!-- Sasaran Layanan -->
       <div id="sasaranLayanan"></div>
       <div><label for="uraianKegiatan" style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Uraian Singkat Kegiatan</label> <textarea id="uraianKegiatan" required rows="4" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
       </div>
       <div><label for="hasilTindakLanjut" style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Hasil &amp; Tindak Lanjut</label> <textarea id="hasilTindakLanjut" required rows="4" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
       </div>
       <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 10px;"><button type="button" onclick="closeModal()" style="padding: 12px 30px; background: #f3f4f6; color: #374151; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;"> Batal </button> <button type="submit" id="submitBtn" style="padding: 12px 30px; background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);"> üíæ Simpan Layanan </button>
       </div>
      </form>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            site_title: "Layanan Bimbingan Konseling",
            institution_name: "Pondok Pesantren Al-Umm"
        };

        // User database
        const users = [
            { nama: "Muhammad Ahmad Taufiq Api Gadi, M.Pd.", peran: "Guru BK", username: "ahmad", password: "2210" },
            { nama: "Bobi Dewi Sriwulandari, S.Psi.", peran: "Guru BK", username: "bobi", password: "2403" },
            { nama: "Heri Bagus Ardiansyah, M.Pd.", peran: "Kepala Sekolah", username: "heri", password: "2202" },
            { nama: "Muchamad Hanafi, S.Pd., Gr.", peran: "Admin", username: "hanafi", password: "1705" },
            { nama: "Rizal Arfiansyah, S.Psi.", peran: "Guru BK", username: "rizal", password: "2102" },
            { nama: "Abd. Wahid, S.Pd., M.Si.", peran: "Kepala Madrasah", username: "wahid", password: "ma01" }
        ];

        let currentUser = null;
        let siswaData = [];
        let laporanData = [];
        let riwayatData = [];
        let currentServiceType = '';
        
        // Fungsi untuk parse tanggal Indonesia (DD/MM/YYYY)
        function parseTanggalIndonesia(tanggalStr) {
            if (!tanggalStr) return null;
            
            const parts = tanggalStr.split('/');
            if (parts.length !== 3) return null;
            
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            
            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            
            return new Date(year, month, day);
        }
        
        // Fungsi untuk format tanggal ke format Indonesia yang lengkap
        function formatTanggalIndonesia(date) {
            if (!date) return '';
            
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const monthName = months[date.getMonth()];
            const year = date.getFullYear();
            
            return `${dayName}, ${day} ${monthName} ${year}`;
        }
        
        // Fungsi untuk konversi tanggal DD/MM/YYYY ke YYYY-MM-DD (untuk input date)
        function convertToInputDate(tanggalIndo) {
            if (!tanggalIndo) return '';
            const parts = tanggalIndo.split('/');
            if (parts.length !== 3) return '';
            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }
        
        // Fungsi untuk konversi YYYY-MM-DD ke DD/MM/YYYY
        function convertFromInputDate(tanggalInput) {
            if (!tanggalInput) return '';
            const parts = tanggalInput.split('-');
            if (parts.length !== 3) return '';
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.style.display = 'none';
                eyeOffIcon.style.display = 'block';
            } else {
                passwordInput.type = 'password';
                eyeIcon.style.display = 'block';
                eyeOffIcon.style.display = 'none';
            }
        }

        // Initialize SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: async (config) => {
                    const siteTitle = config.site_title || defaultConfig.site_title;
                    const institutionName = config.institution_name || defaultConfig.institution_name;
                    
                    document.getElementById('siteTitle').textContent = siteTitle;
                    document.getElementById('institutionName').textContent = institutionName;
                },
                mapToCapabilities: (config) => ({
                    recolorables: [],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["site_title", config.site_title || defaultConfig.site_title],
                    ["institution_name", config.institution_name || defaultConfig.institution_name]
                ])
            });
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    showToast('‚ö†Ô∏è Username dan password harus diisi!', 'error');
                    return;
                }
                
                const user = users.find(u => u.username.toLowerCase().trim() === username.toLowerCase() && u.password.trim() === password);
                
                if (user) {
                    currentUser = user;
                    
                    // Clear form
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    
                    // Update UI
                    document.getElementById('guruName').textContent = `${user.nama} - ${user.peran}`;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    // Show default page
                    showPage('layanan');
                    
                    showToast(`‚úÖ Selamat datang, ${user.nama}!`, 'success');
                    
                    // Load data
                    setTimeout(() => {
                        loadSiswaData();
                        loadLaporanData();
                        loadRiwayatData();
                    }, 500);
                } else {
                    showToast('‚ùå Username atau password salah!', 'error');
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('‚ùå Terjadi kesalahan saat login', 'error');
            }
        });

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Modal functions
        function openServiceModal(type) {
            currentServiceType = type;
            document.getElementById('modalTitle').textContent = type;
            document.getElementById('jenisLayanan').value = type;
            document.getElementById('modalForm').style.display = 'flex';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalLayanan').value = today;
            
            renderSasaranLayanan(type);
        }

        function closeModal() {
            document.getElementById('modalForm').style.display = 'none';
            document.getElementById('serviceForm').reset();
            currentServiceType = '';
        }

        // Navigation
        function showPage(page) {
            document.getElementById('layananPage').style.display = 'none';
            document.getElementById('dataSiswaPage').style.display = 'none';
            document.getElementById('laporanPage').style.display = 'none';
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.style.background = '#f3f4f6';
                btn.style.color = '#374151';
            });
            
            if (page === 'layanan') {
                document.getElementById('layananPage').style.display = 'block';
                document.querySelectorAll('.nav-btn')[0].style.background = 'linear-gradient(135deg, #10b981 0%, #8b5cf6 100%)';
                document.querySelectorAll('.nav-btn')[0].style.color = 'white';
            } else if (page === 'dataSiswa') {
                document.getElementById('dataSiswaPage').style.display = 'block';
                document.querySelectorAll('.nav-btn')[1].style.background = 'linear-gradient(135deg, #10b981 0%, #8b5cf6 100%)';
                document.querySelectorAll('.nav-btn')[1].style.color = 'white';
            } else if (page === 'laporan') {
                document.getElementById('laporanPage').style.display = 'block';
                document.querySelectorAll('.nav-btn')[2].style.background = 'linear-gradient(135deg, #10b981 0%, #8b5cf6 100%)';
                document.querySelectorAll('.nav-btn')[2].style.color = 'white';
            }
        }

        function renderSasaranLayanan(type) {
            const container = document.getElementById('sasaranLayanan');
            let html = '';
            
            if (type === 'Konseling Individu') {
                html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Kelas</label>
                            <select id="kelasIndividu" onchange="updateSiswaDropdown()" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Nama Siswa</label>
                            <select id="namaSiswaIndividu" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
                                <option value="">Pilih Siswa</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (type === 'Konseling Kelompok' || type === 'Bimbingan Kelompok') {
                html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Kelas (Bisa pilih lebih dari satu)</label>
                            <div id="kelasKelompokContainer" style="max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px;"></div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Nama Siswa (Bisa pilih lebih dari satu)</label>
                            <div id="namaSiswaKelompokContainer" style="max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px;"></div>
                        </div>
                    </div>
                `;
            } else if (type === 'Bimbingan Kelas') {
                html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Kelas</label>
                            <select id="kelasBimbingan" onchange="updateSiswaHadir()" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">Siswa yang Hadir (Hilangkan centang jika tidak hadir)</label>
                        <div id="siswaHadirContainer" style="max-height: 300px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 10px; padding: 15px;"></div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            populateKelasOptions();
        }

        function populateKelasOptions() {
            if (siswaData.length === 0) return;
            
            let filteredSiswa = siswaData;
            if (currentUser && currentUser.peran === 'Guru BK') {
                filteredSiswa = siswaData.filter(s => {
                    const guruBKNormalized = s.guruBK.trim().toLowerCase();
                    const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                    return guruBKNormalized === currentUserNormalized;
                });
            }
            
            let kelasSet = new Set(filteredSiswa.map(s => s.kelas).filter(k => k));
            const kelasList = Array.from(kelasSet).sort();
            
            if (currentServiceType === 'Konseling Individu') {
                const select = document.getElementById('kelasIndividu');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    kelasList.map(k => `<option value="${k}">${k}</option>`).join('');
            } else if (currentServiceType === 'Konseling Kelompok' || currentServiceType === 'Bimbingan Kelompok') {
                const container = document.getElementById('kelasKelompokContainer');
                container.innerHTML = kelasList.map(k => `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                        <input type="checkbox" class="kelas-checkbox" value="${k}" onchange="updateSiswaMultiSelect()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 14px; color: #374151;">${k}</span>
                    </label>
                `).join('');
            } else if (currentServiceType === 'Bimbingan Kelas') {
                const select = document.getElementById('kelasBimbingan');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    kelasList.map(k => `<option value="${k}">${k}</option>`).join('');
            }
        }

        function updateSiswaDropdown() {
            const kelas = document.getElementById('kelasIndividu').value;
            const select = document.getElementById('namaSiswaIndividu');
            
            if (!kelas) {
                select.innerHTML = '<option value="">Pilih Siswa</option>';
                return;
            }
            
            const siswaDiKelas = siswaData.filter(s => s.kelas === kelas).sort((a, b) => a.nama.localeCompare(b.nama));
            select.innerHTML = '<option value="">Pilih Siswa</option>' + 
                siswaDiKelas.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('');
        }

        function updateSiswaMultiSelect() {
            const selectedKelas = Array.from(document.querySelectorAll('.kelas-checkbox:checked')).map(cb => cb.value);
            const container = document.getElementById('namaSiswaKelompokContainer');
            
            if (selectedKelas.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-size: 14px; padding: 10px;">Pilih kelas terlebih dahulu</p>';
                return;
            }
            
            const siswaDiKelas = siswaData.filter(s => selectedKelas.includes(s.kelas)).sort((a, b) => a.nama.localeCompare(b.nama));
            container.innerHTML = siswaDiKelas.map(s => `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                    <input type="checkbox" class="siswa-checkbox" value="${s.nama}" data-kelas="${s.kelas}" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 14px; color: #374151;">${s.nama} (${s.kelas})</span>
                </label>
            `).join('');
        }

        function updateSiswaHadir() {
            const kelas = document.getElementById('kelasBimbingan').value;
            const container = document.getElementById('siswaHadirContainer');
            
            if (!kelas) {
                container.innerHTML = '';
                return;
            }
            
            const siswaDiKelas = siswaData.filter(s => s.kelas === kelas).sort((a, b) => a.nama.localeCompare(b.nama));
            
            container.innerHTML = siswaDiKelas.map(s => `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer;">
                    <input type="checkbox" class="hadir-checkbox" value="${s.nama}" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 14px; color: #374151;">${s.nama}</span>
                </label>
            `).join('');
        }

        // Form submission
        document.getElementById('serviceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            const tanggal = document.getElementById('tanggalLayanan').value;
            const jenisLayanan = document.getElementById('jenisLayanan').value;
            const bidangLayanan = Array.from(document.querySelectorAll('input[name="bidangLayanan"]:checked')).map(cb => cb.value).join(', ');
            const uraian = document.getElementById('uraianKegiatan').value;
            const hasil = document.getElementById('hasilTindakLanjut').value;
            
            let kelas = '';
            let namaSiswa = '';
            
            if (jenisLayanan === 'Konseling Individu') {
                kelas = document.getElementById('kelasIndividu').value;
                namaSiswa = document.getElementById('namaSiswaIndividu').value;
            } else if (jenisLayanan === 'Konseling Kelompok' || jenisLayanan === 'Bimbingan Kelompok') {
                const selectedKelas = Array.from(document.querySelectorAll('.kelas-checkbox:checked')).map(cb => cb.value);
                const selectedSiswa = Array.from(document.querySelectorAll('.siswa-checkbox:checked'));
                
                kelas = selectedKelas.join(', ');
                namaSiswa = selectedSiswa.map(cb => `${cb.value} (${cb.dataset.kelas})`).join(', ');
            } else if (jenisLayanan === 'Bimbingan Kelas') {
                kelas = document.getElementById('kelasBimbingan').value;
                const hadirSiswa = Array.from(document.querySelectorAll('.hadir-checkbox:checked')).map(cb => cb.value);
                namaSiswa = hadirSiswa.join(', ');
            }
            
            const data = {
                tanggal: tanggal,
                jenisLayanan: jenisLayanan,
                bidangLayanan: bidangLayanan,
                kelas: kelas,
                namaSiswa: namaSiswa,
                uraianKegiatan: uraian,
                hasilTindakLanjut: hasil
            };
            
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbyoucgsZBCH3nf6z84aSJNfIngn69dDReg1MBOrt6ik7Fjpgqdn6bVOXL3qeQ5kunbo/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                showToast('‚úÖ Data berhasil tersimpan!', 'success');
                closeModal();
                
                setTimeout(() => {
                    showToast('üîÑ Memperbarui data...', 'info');
                    loadRiwayatData();
                    loadLaporanData();
                }, 3000);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Terjadi kesalahan saat menyimpan data', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Simpan Layanan';
            }
        });

        // Load siswa data
        async function loadSiswaData() {
            document.getElementById('loadingSiswa').style.display = 'block';
            document.getElementById('siswaContainer').style.display = 'none';
            
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSbIGQ0Km74b_m2_HJV9ywCW9vS7IXYxklTh3NG14qGTYFoXTDO5yBuYayFaYhVkTN1m6rG-0peeBvt/pub?gid=0&single=true&output=csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                
                siswaData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < lines[i].length; j++) {
                        const char = lines[i][j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());
                    
                    if (values.length >= 4) {
                        const siswa = {
                            nis: values[0]?.replace(/"/g, '').trim() || '',
                            nama: values[1]?.replace(/"/g, '').trim() || '',
                            kelas: values[2]?.replace(/"/g, '').trim() || '',
                            guruBK: values[3]?.replace(/"/g, '').trim() || ''
                        };
                        
                        if (siswa.nis && siswa.nama && siswa.kelas && siswa.guruBK) {
                            siswaData.push(siswa);
                        }
                    }
                }
                
                if (siswaData.length === 0) {
                    document.getElementById('loadingSiswa').innerHTML = '<div style="text-align: center; padding: 40px; color: #f59e0b;">‚ö†Ô∏è Tidak ada data siswa ditemukan. Pastikan spreadsheet berisi data.</div>';
                } else {
                    renderSiswaTable();
                    populateFilterKelas();
                }
                
            } catch (error) {
                console.error('Error loading siswa data:', error);
                document.getElementById('loadingSiswa').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">‚ùå Gagal memuat data siswa. Silakan coba lagi.</div>';
                showToast('‚ö†Ô∏è Gagal memuat data siswa', 'error');
            }
        }

        function renderSiswaTable() {
            const container = document.getElementById('siswaContainer');
            
            let filteredSiswa = siswaData;
            if (currentUser && currentUser.nama && currentUser.peran === 'Guru BK') {
                filteredSiswa = siswaData.filter(s => {
                    const guruBKNormalized = s.guruBK.trim().toLowerCase();
                    const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                    return guruBKNormalized === currentUserNormalized;
                });
            }
            
            const siswaByKelas = {};
            filteredSiswa.forEach(siswa => {
                if (!siswaByKelas[siswa.kelas]) {
                    siswaByKelas[siswa.kelas] = [];
                }
                siswaByKelas[siswa.kelas].push(siswa);
            });
            
            const sortedKelas = Object.keys(siswaByKelas).sort();
            
            const gradients = [
                'linear-gradient(135deg, #10b981 0%, #8b5cf6 100%)',
                'linear-gradient(135deg, #059669 0%, #7c3aed 100%)',
                'linear-gradient(135deg, #34d399 0%, #a78bfa 100%)',
                'linear-gradient(135deg, #6ee7b7 0%, #c4b5fd 100%)',
                'linear-gradient(135deg, #10b981 0%, #9333ea 100%)',
                'linear-gradient(135deg, #047857 0%, #6d28d9 100%)'
            ];
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    ${sortedKelas.map((kelas, kelasIndex) => {
                        const siswaList = siswaByKelas[kelas].sort((a, b) => a.nama.localeCompare(b.nama));
                        const gradient = gradients[kelasIndex % gradients.length];
                        
                        return `
                            <div style="background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden;">
                                <div style="background: ${gradient}; padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="font-size: 20px; font-weight: 700; margin: 0;">üìö Kelas ${kelas}</h3>
                                    <div style="background: rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 10px; font-size: 13px; font-weight: 600;">
                                        ${siswaList.length} siswa
                                    </div>
                                </div>
                                <div style="max-height: 400px; overflow-y: auto; padding: 15px;">
                                    ${siswaList.map((siswa, index) => {
                                        const namaEncoded = btoa(unescape(encodeURIComponent(siswa.nama)));
                                        const kelasEncoded = btoa(unescape(encodeURIComponent(siswa.kelas)));
                                        const nisEncoded = btoa(unescape(encodeURIComponent(siswa.nis)));
                                        
                                        return `
                                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #f3f4f6; transition: all 0.2s; cursor: pointer;"
                                             data-nama="${namaEncoded}"
                                             data-kelas="${kelasEncoded}"
                                             data-nis="${nisEncoded}"
                                             onmouseover="this.style.background='#f9fafb'"
                                             onmouseout="this.style.background='transparent'"
                                             onclick="showRiwayatSiswaFromData(this)">
                                            <div style="width: 35px; height: 35px; background: ${gradient}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 700; flex-shrink: 0;">
                                                ${index + 1}
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-size: 14px; font-weight: 600; color: #1f2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${siswa.nama}</div>
                                                <div style="font-size: 12px; color: #6b7280;">NIS: ${siswa.nis}</div>
                                            </div>
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('loadingSiswa').style.display = 'none';
            document.getElementById('siswaContainer').style.display = 'block';
        }

        function refreshSiswaData() {
            showToast('üîÑ Memuat data siswa terbaru...', 'info');
            loadSiswaData();
        }
        
        function showRiwayatSiswaFromData(element) {
            const namaEncoded = element.getAttribute('data-nama');
            const kelasEncoded = element.getAttribute('data-kelas');
            const nisEncoded = element.getAttribute('data-nis');
            
            const nama = decodeURIComponent(escape(atob(namaEncoded)));
            const kelas = decodeURIComponent(escape(atob(kelasEncoded)));
            const nis = decodeURIComponent(escape(atob(nisEncoded)));
            
            showRiwayatSiswa(nama, kelas, nis);
        }
        
        function showRiwayatSiswa(namaSiswa, kelas, nis) {
            const decodedNama = namaSiswa.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
            
            const riwayatSiswa = riwayatData.filter(r => {
                const namaList = r.namaSiswa.split(',').map(n => {
                    return n.trim().replace(/\s*\([^)]*\)/g, '').trim();
                });
                
                return namaList.some(nama => {
                    return nama.toLowerCase() === decodedNama.toLowerCase() || 
                           nama === decodedNama;
                });
            }).sort((a, b) => {
                const dateA = new Date(a.tanggal);
                const dateB = new Date(b.tanggal);
                return dateB - dateA;
            });
            
            document.getElementById('modalRiwayatTitle').textContent = `Riwayat Layanan - ${decodedNama}`;
            document.getElementById('modalRiwayatSubtitle').textContent = `Kelas ${kelas} ‚Ä¢ NIS: ${nis}`;
            
            const content = document.getElementById('modalRiwayatContent');
            
            if (riwayatSiswa.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Belum Ada Riwayat</div>
                        <div style="font-size: 14px;">Siswa ini belum pernah menerima layanan BK</div>
                    </div>
                `;
            } else {
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                ];
                
                content.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #f5f3ff 100%); border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #10b981; margin-bottom: 5px;">${riwayatSiswa.length}</div>
                        <div style="font-size: 14px; color: #6b7280;">Total Layanan Diterima</div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        ${riwayatSiswa.map((riwayat, index) => {
                            const gradient = gradients[index % gradients.length];
                            
                            return `
                                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; transition: all 0.3s;"
                                     onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 20px rgba(139, 92, 246, 0.2)'"
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">
                                    <div style="background: ${gradient}; padding: 15px; color: white;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="font-size: 15px; font-weight: 700;">${riwayat.jenisLayanan}</div>
                                            <div style="background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                                ÔøΩÔøΩÔøΩ ${riwayat.tanggal}
                                            </div>
                                        </div>
                                        <div style="font-size: 12px; opacity: 0.95;">
                                            <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 6px; display: inline-block;">
                                                ${riwayat.bidangLayanan}
                                            </span>
                                        </div>
                                    </div>
                                    <div style="padding: 15px;">
                                        <div style="margin-bottom: 12px;">
                                            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">üìù URAIAN KEGIATAN</div>
                                            <div style="font-size: 13px; color: #374151; line-height: 1.6;">${riwayat.uraianKegiatan}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">‚úÖ HASIL & TINDAK LANJUT</div>
                                            <div style="font-size: 13px; color: #374151; line-height: 1.6;">${riwayat.hasilTindakLanjut}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            document.getElementById('modalRiwayatSiswa').style.display = 'flex';
        }
        
        function closeRiwayatModal() {
            document.getElementById('modalRiwayatSiswa').style.display = 'none';
        }
        
        // Load riwayat data
        async function loadRiwayatData() {
            const loadingEl = document.getElementById('loadingRiwayat');
            const containerEl = document.getElementById('riwayatContainer');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (containerEl) containerEl.style.display = 'none';
            
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSbIGQ0Km74b_m2_HJV9ywCW9vS7IXYxklTh3NG14qGTYFoXTDO5yBuYayFaYhVkTN1m6rG-0peeBvt/pub?gid=777906128&single=true&output=csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                
                riwayatData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < lines[i].length; j++) {
                        const char = lines[i][j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());
                    
                    if (values.length >= 7 && values[0]) {
                        const tanggalStr = values[0].replace(/"/g, '').trim();
                        const tanggalObj = parseTanggalIndonesia(tanggalStr);
                        
                        const record = {
                            tanggal: tanggalStr,
                            tanggalObj: tanggalObj,
                            jenisLayanan: values[1].replace(/"/g, '').trim(),
                            bidangLayanan: values[2].replace(/"/g, '').trim(),
                            kelas: values[3].replace(/"/g, '').trim(),
                            namaSiswa: values[4].replace(/"/g, '').trim(),
                            uraianKegiatan: values[5].replace(/"/g, '').trim(),
                            hasilTindakLanjut: values[6].replace(/"/g, '').trim()
                        };
                        riwayatData.push(record);
                    }
                }
                
                if (riwayatData.length === 0) {
                    if (loadingEl) {
                        loadingEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #f59e0b;">‚ö†Ô∏è Tidak ada data riwayat ditemukan. Data akan muncul setelah Anda menambahkan layanan.</div>';
                    }
                } else {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    let todayData = riwayatData.filter(l => {
                        if (!l.tanggalObj) return false;
                        const tanggalObj = new Date(l.tanggalObj);
                        tanggalObj.setHours(0, 0, 0, 0);
                        return tanggalObj.getTime() === today.getTime();
                    });
                    
                    if (currentUser && currentUser.peran === 'Guru BK') {
                        const kelasBinaan = [...new Set(siswaData.filter(s => {
                            const guruBKNormalized = s.guruBK.trim().toLowerCase();
                            const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                            return guruBKNormalized === currentUserNormalized;
                        }).map(s => s.kelas))];
                        
                        todayData = todayData.filter(riwayat => {
                            const kelasRiwayat = riwayat.kelas.split(',').map(k => k.trim());
                            return kelasRiwayat.some(k => kelasBinaan.includes(k));
                        });
                    }
                    
                    renderRiwayatTable(todayData);
                    populateRiwayatFilters();
                }
                
            } catch (error) {
                console.error('Error loading riwayat data:', error);
                if (loadingEl) {
                    loadingEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">‚ùå Gagal memuat riwayat layanan. Silakan coba lagi.</div>';
                }
                showToast('‚ö†Ô∏è Gagal memuat riwayat layanan', 'error');
            }
        }

        function populateRiwayatFilters() {
            const kelasSet = new Set(siswaData.map(s => s.kelas).filter(k => k));
            let kelasList = Array.from(kelasSet);
            
            if (currentUser && currentUser.peran === 'Guru BK') {
                const kelasBinaan = [...new Set(siswaData.filter(s => {
                    const guruBKNormalized = s.guruBK.trim().toLowerCase();
                    const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                    return guruBKNormalized === currentUserNormalized;
                }).map(s => s.kelas))];
                
                kelasList = kelasList.filter(k => kelasBinaan.includes(k));
            }
            
            kelasList.sort();
            
            const riwayatKelas = document.getElementById('riwayatKelas');
            if (riwayatKelas) {
                riwayatKelas.innerHTML = '<option value="">Semua Kelas</option>' + 
                    kelasList.map(k => `<option value="${k}">${k}</option>`).join('');
            }
        }
        
        function updateRiwayatSiswa() {
            const kelas = document.getElementById('riwayatKelas').value;
            const riwayatNamaSiswa = document.getElementById('riwayatNamaSiswa');
            
            if (!riwayatNamaSiswa) return;
            
            if (!kelas) {
                riwayatNamaSiswa.innerHTML = '<option value="">Semua Siswa</option>';
                return;
            }
            
            let siswaDiKelas = siswaData.filter(s => s.kelas === kelas);
            
            if (currentUser && currentUser.peran === 'Guru BK') {
                siswaDiKelas = siswaDiKelas.filter(s => {
                    const guruBKNormalized = s.guruBK.trim().toLowerCase();
                    const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                    return guruBKNormalized === currentUserNormalized;
                });
            }
            
            siswaDiKelas.sort((a, b) => a.nama.localeCompare(b.nama));
            
            riwayatNamaSiswa.innerHTML = '<option value="">Semua Siswa</option>' + 
                siswaDiKelas.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('');
        }
        
        function applyRiwayatFilter() {
            const kelas = document.getElementById('riwayatKelas').value;
            const namaSiswa = document.getElementById('riwayatNamaSiswa').value;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let filtered = riwayatData.filter(l => {
                if (!l.tanggalObj) return false;
                const tanggalObj = new Date(l.tanggalObj);
                tanggalObj.setHours(0, 0, 0, 0);
                return tanggalObj.getTime() === today.getTime();
            });
            
            if (currentUser && currentUser.peran === 'Guru BK') {
                const kelasBinaan = [...new Set(siswaData.filter(s => {
                    const guruBKNormalized = s.guruBK.trim().toLowerCase();
                    const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                    return guruBKNormalized === currentUserNormalized;
                }).map(s => s.kelas))];
                
                filtered = filtered.filter(riwayat => {
                    const kelasRiwayat = riwayat.kelas.split(',').map(k => k.trim());
                    return kelasRiwayat.some(k => kelasBinaan.includes(k));
                });
            }
            
            if (kelas) {
                filtered = filtered.filter(l => {
                    const kelasList = l.kelas.split(',').map(k => k.trim());
                    return kelasList.includes(kelas);
                });
            }
            
            if (namaSiswa) {
                filtered = filtered.filter(l => {
                    const namaList = l.namaSiswa.split(',').map(n => {
                        return n.trim().replace(/\s*\([^)]*\)/g, '').trim();
                    });
                    return namaList.some(nama => nama.toLowerCase() === namaSiswa.toLowerCase());
                });
            }
            
            renderRiwayatTable(filtered);
            showToast(`‚úÖ Ditemukan ${filtered.length} data hari ini`, 'success');
        }
        
        function resetRiwayatFilter() {
            document.getElementById('riwayatKelas').value = '';
            document.getElementById('riwayatNamaSiswa').value = '';
            updateRiwayatSiswa();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let filtered = riwayatData.filter(l => {
                if (!l.tanggalObj) return false;
                const tanggalObj = new Date(l.tanggalObj);
                tanggalObj.setHours(0, 0, 0, 0);
                return tanggalObj.getTime() === today.getTime();
            });
            
            if (currentUser && currentUser.peran === 'Guru BK') {
                const kelasBinaan = [...new Set(siswaData.filter(s => {
                    const guruBKNormalized = s.guruBK.trim().toLowerCase();
                    const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                    return guruBKNormalized === currentUserNormalized;
                }).map(s => s.kelas))];
                
                filtered = filtered.filter(riwayat => {
                    const kelasRiwayat = riwayat.kelas.split(',').map(k => k.trim());
                    return kelasRiwayat.some(k => kelasBinaan.includes(k));
                });
            }
            
            renderRiwayatTable(filtered);
            showToast('üîÑ Filter direset - menampilkan data hari ini', 'info');
        }
        
        function renderRiwayatTable(data) {
            const container = document.getElementById('riwayatContainer');
            
            let filteredData = data;
            if (currentUser && currentUser.peran === 'Guru BK') {
                const kelasBinaan = [...new Set(siswaData.filter(s => {
                    const guruBKNormalized = s.guruBK.trim().toLowerCase();
                    const currentUserNormalized = currentUser.nama.trim().toLowerCase();
                    return guruBKNormalized === currentUserNormalized;
                }).map(s => s.kelas))];
                
                filteredData = data.filter(riwayat => {
                    const kelasRiwayat = riwayat.kelas.split(',').map(k => k.trim());
                    return kelasRiwayat.some(k => kelasBinaan.includes(k));
                });
            }
            
            filteredData.sort((a, b) => {
                if (!a.tanggalObj || !b.tanggalObj) return 0;
                return b.tanggalObj - a.tanggalObj;
            });
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280; background: white; border-radius: 16px; grid-column: 1 / -1;">Belum ada riwayat layanan</div>';
                container.style.display = 'grid';
            } else {
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
                ];
                
                container.innerHTML = filteredData.map((riwayat, index) => {
                    const gradient = gradients[index % gradients.length];
                    
                    let formattedNamaSiswa = riwayat.namaSiswa;
                    const isKelompok = riwayat.jenisLayanan.toLowerCase().includes('kelompok');
                    const isKelas = riwayat.jenisLayanan.toLowerCase().includes('kelas');
                    
                    if ((isKelompok || isKelas) && riwayat.namaSiswa) {
                        const namaList = riwayat.namaSiswa.split(',').map(n => n.trim()).filter(n => n);
                        
                        if (namaList.length > 5) {
                            formattedNamaSiswa = `${namaList.length} siswa: ` + 
                                namaList.slice(0, 3).join(', ') + 
                                `, dan ${namaList.length - 3} lainnya`;
                        } else if (namaList.length > 1) {
                            formattedNamaSiswa = namaList.join(', ');
                        }
                    }
                    
                    return `
                        <div style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(139, 92, 246, 0.15); overflow: hidden; transition: all 0.3s; cursor: pointer;" 
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 30px rgba(139, 92, 246, 0.25)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(139, 92, 246, 0.15)'">
                            <div style="background: ${gradient}; padding: 20px; color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="font-size: 16px; font-weight: 700;">${riwayat.jenisLayanan}</div>
                                    <div style="background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                        üìÖ ${riwayat.tanggal}
                                    </div>
                                </div>
                                <div style="font-size: 13px; opacity: 0.95;">
                                    <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 6px; display: inline-block; margin-right: 6px;">
                                        ${riwayat.bidangLayanan}
                                    </span>
                                </div>
                            </div>
                            <div style="padding: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 5px;">üè´ KELAS</div>
                                    <div style="font-size: 14px; color: #1f2937; font-weight: 600;">${riwayat.kelas}</div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 5px;">üë§ NAMA SISWA</div>
                                    <div style="font-size: 14px; color: #1f2937; line-height: 1.5;">${formattedNamaSiswa}</div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 5px;">üìù URAIAN KEGIATAN</div>
                                    <div style="font-size: 13px; color: #374151; line-height: 1.6;">${riwayat.uraianKegiatan}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 5px;">‚úÖ HASIL & TINDAK LANJUT</div>
                                    <div style="font-size: 13px; color: #374151; line-height: 1.6;">${riwayat.hasilTindakLanjut}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                container.style.display = 'grid';
            }
            
            const loadingEl = document.getElementById('loadingRiwayat');
            if (loadingEl) loadingEl.style.display = 'none';
        }
        
        function refreshRiwayatData() {
            showToast('üîÑ Memuat riwayat terbaru...', 'info');
            loadRiwayatData();
        }

        // Load laporan data
        async function loadLaporanData() {
            document.getElementById('loadingLaporan').style.display = 'block';
            document.getElementById('tableLaporan').style.display = 'none';
            
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSbIGQ0Km74b_m2_HJV9ywCW9vS7IXYxklTh3NG14qGTYFoXTDO5yBuYayFaYhVkTN1m6rG-0peeBvt/pub?gid=777906128&single=true&output=csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n').slice(1);
                laporanData = [];
                
                for (let i = 0; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < lines[i].length; j++) {
                        const char = lines[i][j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());
                    
                    if (values.length >= 7 && values[0]) {
                        const tanggalStr = values[0].replace(/"/g, '').trim();
                        const tanggalObj = parseTanggalIndonesia(tanggalStr);
                        
                        laporanData.push({
                            tanggal: tanggalStr,
                            tanggalObj: tanggalObj,
                            jenisLayanan: values[1].replace(/"/g, '').trim(),
                            bidangLayanan: values[2].replace(/"/g, '').trim(),
                            kelas: values[3].replace(/"/g, '').trim(),
                            namaSiswa: values[4].replace(/"/g, '').trim(),
                            uraianKegiatan: values[5].replace(/"/g, '').trim(),
                            hasilTindakLanjut: values[6].replace(/"/g, '').trim()
                        });
                    }
                }
                
                renderLaporanSummary();
                renderLaporanTable(laporanData);
                
            } catch (error) {
                console.error('Error loading laporan data:', error);
                document.getElementById('loadingLaporan').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">‚ùå Gagal memuat data laporan. Silakan coba lagi.</div>';
                showToast('‚ö†Ô∏è Gagal memuat data laporan', 'error');
            }
        }

        function renderLaporanSummary() {
            const layananPerKelas = {};
            
            laporanData.forEach(l => {
                const kelasList = l.kelas.split(',').map(k => k.trim()).filter(k => k);
                kelasList.forEach(kelas => {
                    if (!layananPerKelas[kelas]) {
                        layananPerKelas[kelas] = {
                            'Konseling Individu': 0,
                            'Konseling Kelompok': 0,
                            'Bimbingan Kelompok': 0,
                            'Bimbingan Kelas': 0,
                            total: 0
                        };
                    }
                    
                    const jenis = l.jenisLayanan.trim();
                    if (layananPerKelas[kelas][jenis] !== undefined) {
                        layananPerKelas[kelas][jenis]++;
                    }
                    layananPerKelas[kelas].total++;
                });
            });
            
            const diagramContainer = document.getElementById('diagramContainer');
            const sortedKelas = Object.keys(layananPerKelas).sort();
            
            const colors = {
                'Konseling Individu': '#10b981',
                'Konseling Kelompok': '#8b5cf6',
                'Bimbingan Kelompok': '#f59e0b',
                'Bimbingan Kelas': '#ec4899'
            };
            
            diagramContainer.innerHTML = sortedKelas.map(kelas => {
                const data = layananPerKelas[kelas];
                const total = data.total;
                
                if (total === 0) return '';
                
                let currentAngle = 0;
                const segments = [];
                
                Object.keys(colors).forEach(jenis => {
                    if (data[jenis] > 0) {
                        const percentage = (data[jenis] / total) * 100;
                        const angle = (data[jenis] / total) * 360;
                        segments.push({
                            jenis: jenis,
                            count: data[jenis],
                            percentage: percentage,
                            startAngle: currentAngle,
                            endAngle: currentAngle + angle,
                            color: colors[jenis]
                        });
                        currentAngle += angle;
                    }
                });
                
                const size = 120;
                const center = size / 2;
                const radius = 45;
                
                const svgPaths = segments.map(seg => {
                    const startAngle = seg.startAngle - 90;
                    const endAngle = seg.endAngle - 90;
                    
                    const x1 = center + radius * Math.cos(startAngle * Math.PI / 180);
                    const y1 = center + radius * Math.sin(startAngle * Math.PI / 180);
                    const x2 = center + radius * Math.cos(endAngle * Math.PI / 180);
                    const y2 = center + radius * Math.sin(endAngle * Math.PI / 180);
                    
                    const largeArc = (seg.endAngle - seg.startAngle) > 180 ? 1 : 0;
                    
                    return `
                        <path d="M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" 
                              fill="${seg.color}" 
                              stroke="white" 
                              stroke-width="1.5"
                              style="transition: all 0.3s;"
                              onmouseover="this.style.opacity='0.8'"
                              onmouseout="this.style.opacity='1'">
                        </path>
                    `;
                }).join('');
                
                const legend = segments.map(seg => `
                    <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #374151;">
                        <div style="width: 12px; height: 12px; background: ${seg.color}; border-radius: 3px; flex-shrink: 0;"></div>
                        <span style="font-weight: 600;">${seg.count}</span>
                        <span style="color: #6b7280;">${seg.jenis.replace('Konseling ', 'K. ').replace('Bimbingan ', 'B. ')}</span>
                    </div>
                `).join('');
                
                return `
                    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #f5f3ff 100%); border-radius: 12px; padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="flex-shrink: 0;">
                                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                                    ${svgPaths}
                                    <circle cx="${center}" cy="${center}" r="32" fill="white" stroke="none"></circle>
                                    <text x="${center}" y="${center - 5}" text-anchor="middle" style="font-size: 20px; font-weight: 700; fill: #1f2937;">${total}</text>
                                    <text x="${center}" y="${center + 10}" text-anchor="middle" style="font-size: 9px; fill: #6b7280;">layanan</text>
                                </svg>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 10px;">
                                    Kelas ${kelas}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    ${legend}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLaporanTable(data) {
            const sortedData = [...data].sort((a, b) => {
                if (!a.tanggalObj || !b.tanggalObj) return 0;
                return b.tanggalObj - a.tanggalObj;
            });
            
            const tbody = document.getElementById('laporanTableBody');
            tbody.innerHTML = sortedData.map((laporan, index) => `
                <tr style="border-bottom: 1px solid #e5e7eb; ${index % 2 === 0 ? 'background: #f9fafb;' : ''}">
                    <td style="padding: 15px; color: #374151;">${laporan.tanggal}</td>
                    <td style="padding: 15px; color: #374151;">${laporan.jenisLayanan}</td>
                    <td style="padding: 15px; color: #374151;">${laporan.bidangLayanan}</td>
                    <td style="padding: 15px; color: #374151;">${laporan.kelas}</td>
                    <td style="padding: 15px; color: #374151;">${laporan.namaSiswa}</td>
                    <td style="padding: 15px; color: #374151; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${laporan.uraianKegiatan}</td>
                    <td style="padding: 15px; color: #374151; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${laporan.hasilTindakLanjut}</td>
                </tr>
            `).join('');
            
            document.getElementById('loadingLaporan').style.display = 'none';
            document.getElementById('tableLaporan').style.display = 'table';
        }

        function printLaporan() {
            const selectedPrincipal = document.getElementById('prinicipalSelect').value;
            
            if (!selectedPrincipal) {
                showToast('‚ö†Ô∏è Pilih Kepala Sekolah/Madrasah terlebih dahulu', 'error');
                return;
            }
            
            // Get current filter values
            const tanggalMulai = document.getElementById('filterTanggalMulai').value;
            const tanggalSelesai = document.getElementById('filterTanggalSelesai').value;
            const kelas = document.getElementById('filterKelas').value;
            const namaSiswa = document.getElementById('filterNamaSiswa').value;
            // Apply filters to get current data
            let filtered = laporanData;
            
            if (tanggalMulai) {
                const mulaiObj = new Date(tanggalMulai);
                mulaiObj.setHours(0, 0, 0, 0);
                
                filtered = filtered.filter(l => {
                    if (!l.tanggalObj) return false;
                    const tanggalObj = new Date(l.tanggalObj);
                    tanggalObj.setHours(0, 0, 0, 0);
                    return tanggalObj >= mulaiObj;
                });
            }
            
            if (tanggalSelesai) {
                const selesaiObj = new Date(tanggalSelesai);
                selesaiObj.setHours(23, 59, 59, 999);
                
                filtered = filtered.filter(l => {
                    if (!l.tanggalObj) return false;
                    const tanggalObj = new Date(l.tanggalObj);
                    tanggalObj.setHours(0, 0, 0, 0);
                    return tanggalObj <= selesaiObj;
                });
            }
            
            if (kelas) {
                filtered = filtered.filter(l => {
                    const kelasList = l.kelas.split(',').map(k => k.trim());
                    return kelasList.includes(kelas);
                });
            }
            
            if (namaSiswa) {
                filtered = filtered.filter(l => {
                    const namaList = l.namaSiswa.split(',').map(n => {
                        return n.trim().replace(/\s*\([^)]*\)/g, '').trim();
                    });
                    return namaList.some(nama => nama.toLowerCase() === namaSiswa.toLowerCase());
                });
            }
            
            // Calculate statistics
            const stats = calculateLaporanStats(filtered);
            
            // Format tanggal cetak
            const today = new Date();
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const printDate = `${today.getDate()} ${monthNames[today.getMonth()]} ${today.getFullYear()}`;
            
            // Landscape layout settings
            const containerStyle = 'max-width: 297mm; min-height: 210mm;';
            const tableStyle = 'font-size: 10px;';
            const thStyle = 'padding: 10px 6px;';
            const tdStyle = 'padding: 8px 6px;';
            
            // Generate print content
            const printContent = `
                <!DOCTYPE html>
                <html lang="id">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Laporan Layanan BK</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            padding: 0;
                        }
                        
                        @page {
                            size: A4 landscape;
                            margin: 15mm 15mm 15mm 15mm;
                        }
                        
                        @media print {
                            body {
                                padding: 0;
                                margin: 0;
                                width: 297mm;
                                height: 210mm;
                            }
                        }
                        
                        .print-container {
                            ${containerStyle}
                            margin: 0 auto;
                            background: white;
                            padding: 20px;
                        }
                        
                        .header {
                            display: flex;
                            align-items: center;
                            gap: 20px;
                            border-bottom: 3px solid #10b981;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        
                        .logo-placeholder {
                            width: 70px;
                            height: 70px;
                            background: linear-gradient(135deg, #10b981 0%, #8b5cf6 100%);
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 40px;
                            font-weight: 700;
                            flex-shrink: 0;
                        }
                        
                        .header-info h1 {
                            font-size: 20px;
                            font-weight: 700;
                            color: #1f2937;
                            margin-bottom: 5px;
                        }
                        
                        .header-info p {
                            font-size: 13px;
                            color: #6b7280;
                            margin: 2px 0;
                        }
                        
                        .print-date {
                            text-align: right;
                            font-size: 12px;
                            color: #6b7280;
                            margin-bottom: 20px;
                        }
                        
                        .statistics {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                            margin-bottom: 30px;
                        }
                        
                        .stat-card {
                            background: linear-gradient(135deg, #f0fdf4 0%, #f5f3ff 100%);
                            border-left: 4px solid #10b981;
                            padding: 15px;
                            border-radius: 8px;
                            page-break-inside: avoid;
                        }
                        
                        .stat-card.konseling-ind {
                            border-left-color: #10b981;
                        }
                        
                        .stat-card.konseling-kel {
                            border-left-color: #8b5cf6;
                        }
                        
                        .stat-card.bimbingan-kel {
                            border-left-color: #f59e0b;
                        }
                        
                        .stat-card.bimbingan-kelas {
                            border-left-color: #ec4899;
                        }
                        
                        .stat-card .number {
                            font-size: 28px;
                            font-weight: 700;
                            color: #1f2937;
                        }
                        
                        .stat-card .label {
                            font-size: 12px;
                            color: #6b7280;
                            font-weight: 600;
                            margin-top: 5px;
                        }
                        
                        .filter-info {
                            background: #f3f4f6;
                            padding: 12px 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            font-size: 12px;
                            color: #6b7280;
                        }
                        
                        .table-wrapper {
                            margin-bottom: 30px;
                            page-break-inside: avoid;
                        }
                        
                        .table-title {
                            font-size: 16px;
                            font-weight: 700;
                            color: #1f2937;
                            margin-bottom: 12px;
                            border-bottom: 2px solid #10b981;
                            padding-bottom: 10px;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            ${tableStyle}
                        }
                        
                        thead tr {
                            background: linear-gradient(135deg, #f0fdf4 0%, #f5f3ff 100%);
                            border-bottom: 2px solid #e5e7eb;
                        }
                        
                        th {
                            ${thStyle}
                            text-align: left;
                            font-weight: 700;
                            color: #374151;
                        }
                        
                        td {
                            ${tdStyle}
                            border-bottom: 1px solid #e5e7eb;
                        }
                        
                        tbody tr {
                            page-break-inside: avoid;
                        }
                        
                        tbody tr:nth-child(even) {
                            background: #f9fafb;
                        }
                        
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #e5e7eb;
                            text-align: center;
                            font-size: 11px;
                            color: #6b7280;
                        }
                        
                        .signature-section {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 60px;
                            margin-top: 50px;
                            page-break-inside: avoid;
                        }
                        
                        .signature-box {
                            text-align: center;
                        }
                        
                        .signature-box p {
                            font-size: 11px;
                            color: #6b7280;
                            margin-bottom: 60px;
                        }
                        
                        .signature-box strong {
                            font-size: 11px;
                            color: #1f2937;
                        }
                        
                        .no-data {
                            text-align: center;
                            padding: 30px;
                            color: #6b7280;
                            font-size: 13px;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        <!-- Header -->
                        <div class="header">
                            <img src="https://iili.io/fENwpbp.md.png" alt="Logo Pondok Pesantren" style="width: 70px; height: 70px; border-radius: 12px; object-fit: cover;">
                            <div class="header-info">
                                <h1>Laporan Layanan Bimbingan Konseling</h1>
                                <p><strong>Pondok Pesantren Al-Umm Malang</strong></p>
                                <p>Jl. Joyo Agung No.1 Merjosari, Lowokwaru, Kota Malang</p>
                            </div>
                        </div>
                        
                        <div class="print-date">Dicetak pada: ${printDate}</div>
                        
                        <!-- Statistics -->
                        <div class="statistics">
                            <div class="stat-card konseling-ind">
                                <div class="number">${stats.konselingIndividu}</div>
                                <div class="label">Konseling Individu</div>
                            </div>
                            <div class="stat-card konseling-kel">
                                <div class="number">${stats.konselingKelompok}</div>
                                <div class="label">Konseling Kelompok</div>
                            </div>
                            <div class="stat-card bimbingan-kel">
                                <div class="number">${stats.bimbinganKelompok}</div>
                                <div class="label">Bimbingan Kelompok</div>
                            </div>
                            <div class="stat-card bimbingan-kelas">
                                <div class="number">${stats.bimbinganKelas}</div>
                                <div class="label">Bimbingan Kelas</div>
                            </div>
                        </div>
                        
                        <!-- Filter Info -->
                        ${generateFilterInfo(tanggalMulai, tanggalSelesai, kelas, namaSiswa)}
                        
                        <!-- Main Statistics -->
                        <div class="table-wrapper">
                            <div class="table-title">üìä Ringkasan Statistik</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Kategori</th>
                                        <th>Jumlah</th>
                                        <th>Persentase</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateStatisticsRows(stats)}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Data Table -->
                        <div class="table-wrapper">
                            <div class="table-title">üìã Detail Layanan</div>
                            ${filtered.length > 0 ? `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Tanggal</th>
                                            <th>Jenis Layanan</th>
                                            <th>Bidang</th>
                                            <th>Kelas</th>
                                            <th>Nama Siswa</th>
                                            <th>Uraian Kegiatan</th>
                                            <th>Hasil & Tindak Lanjut</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filtered.map((item, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${item.tanggal}</td>
                                                <td>${item.jenisLayanan}</td>
                                                <td>${item.bidangLayanan}</td>
                                                <td>${item.kelas}</td>
                                                <td>${item.namaSiswa}</td>
                                                <td>${item.uraianKegiatan}</td>
                                                <td>${item.hasilTindakLanjut}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : `
                                <div class="no-data">Tidak ada data untuk dicetak</div>
                            `}
                        </div>
                        
                        <!-- Signature Section -->
                        <div class="signature-section">
                            <div class="signature-box">
                                <p style="font-size: 12px; color: #333; margin-bottom: 60px;">${selectedPrincipal.includes('Heri Bagus Ardiansyah') ? 'Kepala Sekolah,' : 'Kepala Madrasah,'}</p>
                                <strong style="font-size: 11px; color: #333;">_____________________</strong>
                                <p style="font-size: 11px; color: #333; margin-top: 12px; font-weight: 600;">${selectedPrincipal}</p>
                            </div>
                            <div class="signature-box">
                                <p style="font-size: 12px; color: #333; margin-bottom: 60px;">Guru Bimbingan & Konseling</p>
                                <strong style="font-size: 11px; color: #333;">_____________________</strong>
                                <p style="font-size: 11px; color: #333; margin-top: 12px; font-weight: 600;">${currentUser ? currentUser.nama : 'Nama Guru BK'}</p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="footer">
                            <p>¬© Pondok Pesantren Al-Umm - Sistem Layanan Bimbingan & Konseling</p>
                            <p>Laporan ini digenerate otomatis dan berlaku sebagai dokumen resmi</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Open print window
            const printWindow = window.open('', 'PRINT_WINDOW', 'width=900,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            };
        }
        
        function calculateLaporanStats(data) {
            const stats = {
                konselingIndividu: 0,
                konselingKelompok: 0,
                bimbinganKelompok: 0,
                bimbinganKelas: 0,
                bidangPribadi: 0,
                bidangSosial: 0,
                bidangBelajar: 0,
                bidangKarir: 0,
                total: data.length
            };
            
            data.forEach(item => {
                const jenis = item.jenisLayanan.trim();
                if (jenis === 'Konseling Individu') stats.konselingIndividu++;
                else if (jenis === 'Konseling Kelompok') stats.konselingKelompok++;
                else if (jenis === 'Bimbingan Kelompok') stats.bimbinganKelompok++;
                else if (jenis === 'Bimbingan Kelas') stats.bimbinganKelas++;
                
                const bidang = item.bidangLayanan.split(',').map(b => b.trim());
                bidang.forEach(b => {
                    if (b === 'Pribadi') stats.bidangPribadi++;
                    else if (b === 'Sosial') stats.bidangSosial++;
                    else if (b === 'Belajar') stats.bidangBelajar++;
                    else if (b === 'Karir') stats.bidangKarir++;
                });
            });
            
            return stats;
        }
        
        function generateFilterInfo(tanggalMulai, tanggalSelesai, kelas, namaSiswa) {
            let filterText = 'Filter: ';
            let filters = [];
            
            if (tanggalMulai && tanggalSelesai) {
                filters.push(`Periode ${tanggalMulai} s/d ${tanggalSelesai}`);
            } else if (tanggalMulai) {
                filters.push(`Dari tanggal ${tanggalMulai}`);
            } else if (tanggalSelesai) {
                filters.push(`Sampai tanggal ${tanggalSelesai}`);
            }
            
            if (kelas) filters.push(`Kelas ${kelas}`);
            if (namaSiswa) filters.push(`Siswa ${namaSiswa}`);
            
            if (filters.length === 0) {
                filters.push('Semua Data');
            }
            
            return `<div class="filter-info">${filterText}${filters.join(' ‚Ä¢ ')}</div>`;
        }
        
        function generateStatisticsRows(stats) {
            const total = stats.total > 0 ? stats.total : 1;
            
            return `
                <tr>
                    <td><strong>Konseling Individu</strong></td>
                    <td><strong>${stats.konselingIndividu}</strong></td>
                    <td><strong>${((stats.konselingIndividu / total) * 100).toFixed(1)}%</strong></td>
                </tr>
                <tr>
                    <td><strong>Konseling Kelompok</strong></td>
                    <td><strong>${stats.konselingKelompok}</strong></td>
                    <td><strong>${((stats.konselingKelompok / total) * 100).toFixed(1)}%</strong></td>
                </tr>
                <tr>
                    <td><strong>Bimbingan Kelompok</strong></td>
                    <td><strong>${stats.bimbinganKelompok}</strong></td>
                    <td><strong>${((stats.bimbinganKelompok / total) * 100).toFixed(1)}%</strong></td>
                </tr>
                <tr>
                    <td><strong>Bimbingan Kelas</strong></td>
                    <td><strong>${stats.bimbinganKelas}</strong></td>
                    <td><strong>${((stats.bimbinganKelas / total) * 100).toFixed(1)}%</strong></td>
                </tr>
                <tr style="background: linear-gradient(135deg, #f0fdf4 0%, #f5f3ff 100%); font-weight: 700;">
                    <td><strong>TOTAL LAYANAN</strong></td>
                    <td><strong>${stats.total}</strong></td>
                    <td><strong>100%</strong></td>
                </tr>
            `;
        }

        function populateFilterKelas() {
            const kelasSet = new Set(siswaData.map(s => s.kelas).filter(k => k));
            let kelasList = Array.from(kelasSet);
            
            kelasList.sort();
            
            const filterKelas = document.getElementById('filterKelas');
            filterKelas.innerHTML = '<option value="">Semua Kelas</option>' + 
                kelasList.map(k => `<option value="${k}">${k}</option>`).join('');
        }

        function updateFilterSiswa() {
            const kelas = document.getElementById('filterKelas').value;
            const filterSiswa = document.getElementById('filterNamaSiswa');
            
            if (!kelas) {
                filterSiswa.innerHTML = '<option value="">Semua Siswa</option>';
                return;
            }
            
            let siswaDiKelas = siswaData.filter(s => s.kelas === kelas);
            
            siswaDiKelas.sort((a, b) => a.nama.localeCompare(b.nama));
            
            filterSiswa.innerHTML = '<option value="">Semua Siswa</option>' + 
                siswaDiKelas.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('');
        }

        function applyFilter() {
            const tanggalMulai = document.getElementById('filterTanggalMulai').value;
            const tanggalSelesai = document.getElementById('filterTanggalSelesai').value;
            const kelas = document.getElementById('filterKelas').value;
            const namaSiswa = document.getElementById('filterNamaSiswa').value;
            
            let filtered = laporanData;
            
            if (tanggalMulai) {
                const mulaiObj = new Date(tanggalMulai);
                mulaiObj.setHours(0, 0, 0, 0);
                
                filtered = filtered.filter(l => {
                    if (!l.tanggalObj) return false;
                    const tanggalObj = new Date(l.tanggalObj);
                    tanggalObj.setHours(0, 0, 0, 0);
                    return tanggalObj >= mulaiObj;
                });
            }
            
            if (tanggalSelesai) {
                const selesaiObj = new Date(tanggalSelesai);
                selesaiObj.setHours(23, 59, 59, 999);
                
                filtered = filtered.filter(l => {
                    if (!l.tanggalObj) return false;
                    const tanggalObj = new Date(l.tanggalObj);
                    tanggalObj.setHours(0, 0, 0, 0);
                    return tanggalObj <= selesaiObj;
                });
            }
            
            if (kelas) {
                filtered = filtered.filter(l => {
                    const kelasList = l.kelas.split(',').map(k => k.trim());
                    return kelasList.includes(kelas);
                });
            }
            
            if (namaSiswa) {
                filtered = filtered.filter(l => {
                    const namaList = l.namaSiswa.split(',').map(n => {
                        return n.trim().replace(/\s*\([^)]*\)/g, '').trim();
                    });
                    return namaList.some(nama => nama.toLowerCase() === namaSiswa.toLowerCase());
                });
            }
            
            renderLaporanTable(filtered);
            showToast(`‚úÖ Ditemukan ${filtered.length} data`, 'success');
        }
        
        function resetFilter() {
            document.getElementById('filterTanggalMulai').value = '';
            document.getElementById('filterTanggalSelesai').value = '';
            document.getElementById('filterKelas').value = '';
            document.getElementById('filterNamaSiswa').value = '';
            renderLaporanTable(laporanData);
            showToast('üîÑ Filter direset', 'info');
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast fade-in';
            
            let bgColor = '#10b981';
            if (type === 'error') bgColor = '#ef4444';
            if (type === 'info') bgColor = '#3b82f6';
            
            toast.innerHTML = `
                <div style="background: ${bgColor}; color: white; padding: 16px 24px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 14px; font-weight: 600;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cd98ced65280fad',t:'MTc3MTA0MDQ5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
